# Weekly report - 24th november 2024

The project is completed up until the point of introducing IoT functionalities. It is collecting data at the moment 
about the temperature (outside) and distance.

The temperature probe has been placed outside trough a hole in the window frame, to allow for more diverse values, 
while the distance sensor has been placed pointing towards a chair used frequently to get diferent data. The time 
between lectures has been set to 3 minutes to avoid overflooding the database with too much data, as I plan on leaving it 
runing for some days to have data from multiple days.

## Arduino

The arduino has been connected to the sesnsors and reading LED as the diagram below shows.

![arduino_wiring](https://github.com/user-attachments/assets/2c16ab80-b0de-4e69-a2a5-5df5fc79a533)

And the code used is:

```csharp
#include <HCSR04.h>
#include <OneWire.h>
#include <DallasTemperature.h>


#define TRIG_PIN 8
#define ECHO_PIN 7
#define TEMP_PIN 10


OneWire ds(TEMP_PIN);
DallasTemperature sensors(&ds);


HCSR04 distanceSensor(TRIG_PIN, ECHO_PIN);


int pinLed = 12;


void setup() {
  Serial.begin(9600);
  Serial.println("setup...");
  sensors.begin();
  digitalWrite(pinLed, LOW);
}


void loop() {
  char c;
  int distance;
  float temp;
  String cad;
  distance = get_distance();
  temp = get_temperature();
  readSerial();
  digitalWrite(pinLed, HIGH);
  delay(250);
  digitalWrite(pinLed, LOW);


  cad = "#1:" + String(distance) + "#2:" + String(temp) + "@";


  Serial.println(cad);


  delay(180000);
}


double get_distance() {
  int d = distanceSensor.dist();


  return d;
}


float get_temperature() {
  float f = -127;
  sensors.requestTemperatures();
  delay(100);
  f = sensors.getTempCByIndex(0);


  return f;
}


char readSerial() {
  if (Serial.available()) {
    char c_ = Serial.read();
    if (c_ == 'H') {
      digitalWrite(pinLed, HIGH);
    } else if (c_ == 'L') {
      digitalWrite(pinLed, LOW);
    }
  }
}
```

The code has been slightly modified to turn on the LED when the sensors are requested to read insted of when 
something is received trough the Serial. Also, the `distanceSensor()` function call is made now from the `HCSR04` 
module.

## Database

The database is runing smoothly and several consults have been made to ensure it all works as expected. It is 
currently storing the data each 3 minutes, as it is sent by the arduino to the Raspberry. A screenshot of the current 
state of the database is given below.

![db](https://github.com/user-attachments/assets/2592c278-7826-47d1-a315-d27cee00ef06)

## Raspberri Pi

The code used for the raspberry has been slightly altered as the libraries used are not the same as the ones 
specified. See more in [Notes](#notes).

The code is shown below:

```python
def cad_proc(cad):
        print("\n\nStart------------------------>" + cad)
        i = cad.find("@")
        while (i > 0):
                #Delete first #
                j = cad.find("#")
                cad = cad[j + 1:]
                aux = cad

                j = cad.find("#")
                if (j < 0):
                        j = cad.find("@")
                aux = aux[:j]
                cad = cad[j:]

                x = aux.find(":")
                sensor = aux[:x]
                value = aux[x + 1:]

                print("sensor:" + sensor)
                print("value:" + value)
                send_mysql(sensor, value)
                i = cad.find("@")

def send_mysql(sensor_, value_):
        cnx = _mysql.connect("127.0.0.1", "user", "1234", "tfg_data_collection")
        query = "Insert into data (sensor_id, data) VALUES (" + sensor_ + "," +                                                                                                                                                              value_ + ");"
        cursor = cnx
        print(query)
        cursor.query(query)
        cnx.commit()
        cursor.close()

while True:
        line = arduino.readline()
        cad_proc(str(line))
arduino.close()
```

## Notes

* The execution of the python script at startup has been made by adding a **systemd service** as suggested by [this stack overflow thread](https://stackoverflow.com/questions/76614070/run-python-script-on-raspberry-pi-4-on-startup-reboot)
  since the old method of editing `/etc/rc.local` no longer works.
* The libraries installed in the raspberry are `serial` (instead of `pyserial`) and `python-mysqldb`(instead of `mysql-connector-python`)
  since installing using pip does not work outside a python venv. The instalation has thus been made using `pipx` for pyserial
  and `sudo apt-get install python-mysqldb` for the database connector.
